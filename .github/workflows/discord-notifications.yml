name: Discord Notifications

on:
  push:
    branches:
      - main
  release:
    types: [published]

jobs:
  notify-commit:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification for commit
        env:
          DISCORD_WEBHOOK: ${{ secrets.COMMIT_WEBHOOK }}
        run: |
          COMMIT_MESSAGE=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
          COMMIT_URL="${{ github.event.head_commit.url }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"
          REPO="${{ github.repository }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸ“ New Commit to $REPO",
              "description": "$COMMIT_MESSAGE",
              "url": "$COMMIT_URL",
              "color": 5814783,
              "fields": [
                {
                  "name": "Author",
                  "value": "$AUTHOR",
                  "inline": true
                },
                {
                  "name": "Branch",
                  "value": "main",
                  "inline": true
                }
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"

  notify-release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification for release
        env:
          DISCORD_WEBHOOK: ${{ secrets.RELEASE_WEBHOOK }}
        run: |
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          RELEASE_BODY=$(echo "${{ github.event.release.body }}" | head -c 500)
          AUTHOR="${{ github.event.release.author.login }}"
          REPO="${{ github.repository }}"

          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "ðŸš€ New Release: $RELEASE_NAME",
              "description": "$RELEASE_BODY",
              "url": "$RELEASE_URL",
              "color": 3066993,
              "fields": [
                {
                  "name": "Version",
                  "value": "$RELEASE_TAG",
                  "inline": true
                },
                {
                  "name": "Released by",
                  "value": "$AUTHOR",
                  "inline": true
                }
              ],
              "timestamp": "${{ github.event.release.published_at }}"
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$PAYLOAD" \
               "$DISCORD_WEBHOOK"
