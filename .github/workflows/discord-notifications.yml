name: Discord Notifications

on:
  push:
    branches: [ main ]
  release:
    types: [published, created, released]

jobs:
  notify-commit:
    name: Notify Discord - Commit
    runs-on: [self-hosted, Linux, docker]
    if: github.event_name == 'push'

    steps:
      - name: Send commit notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.COMMIT_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"New Commit to ${{ github.repository }}\",
                \"description\": \"[${{ github.event.head_commit.message }}](${{ github.event.head_commit.url }})\",
                \"color\": 5814783,
                \"fields\": [
                  {
                    \"name\": \"Author\",
                    \"value\": \"${{ github.event.head_commit.author.name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Branch\",
                    \"value\": \"${{ github.ref_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Commit\",
                    \"value\": \"[\`${{ github.sha }}\`](${{ github.event.head_commit.url }})\",
                    \"inline\": false
                  }
                ],
                \"timestamp\": \"${{ github.event.head_commit.timestamp }}\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

  notify-release:
    name: Notify Discord - Release
    runs-on: [self-hosted, Linux, docker]
    if: github.event_name == 'release'

    steps:
      - name: Send release notification to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.RELEASE_WEBHOOK }}
        run: |
          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"New Release: ${{ github.event.release.name || github.event.release.tag_name }}\",
                \"description\": \"${{ github.event.release.body }}\",
                \"url\": \"${{ github.event.release.html_url }}\",
                \"color\": 3066993,
                \"fields\": [
                  {
                    \"name\": \"Tag\",
                    \"value\": \"${{ github.event.release.tag_name }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Published by\",
                    \"value\": \"${{ github.event.release.author.login }}\",
                    \"inline\": true
                  },
                  {
                    \"name\": \"Prerelease\",
                    \"value\": \"${{ github.event.release.prerelease }}\",
                    \"inline\": true
                  }
                ],
                \"timestamp\": \"${{ github.event.release.published_at }}\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
