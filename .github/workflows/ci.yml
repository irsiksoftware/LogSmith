name: CI - Unity Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  UNITY_VERSION: 6000.3.2f1

jobs:
  test:
    name: Test Unity 6000.3.2f1
    runs-on: [self-hosted, unity-pool]
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Unity License
        shell: powershell
        run: |
          $LICENSE_DIR = "$env:LOCALAPPDATA\Unity\licenses"
          New-Item -ItemType Directory -Force -Path $LICENSE_DIR | Out-Null
          $LICENSE_FILE = "$LICENSE_DIR\UnityEntitlementLicense.xml"

          # Retry logic for file write (handles parallel runner race conditions)
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.UNITY_LICENSE }}")) | Out-File -FilePath $LICENSE_FILE -Encoding UTF8 -NoNewline
              $success = $true
              Write-Host "Unity license installed at: $LICENSE_FILE"
            } catch {
              $retryCount++
              if ($retryCount -lt $maxRetries) {
                Write-Host "License file locked, retrying... (Attempt $retryCount/$maxRetries)"
                Start-Sleep -Seconds 1
              } else {
                throw "Failed to write license file after $maxRetries attempts: $_"
              }
            }
          }

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ env.UNITY_VERSION }}-${{ hashFiles('Packages/packages-lock.json', 'Packages/manifest.json') }}
          restore-keys: |
            Library-${{ env.UNITY_VERSION }}-
            Library-

      - name: Find Unity Editor Path
        id: unity-path
        shell: powershell
        run: |
          $UNITY_PATH = "C:/Program Files/Unity/Hub/Editor/${{ env.UNITY_VERSION }}/Editor/Unity.exe"

          if (-Not (Test-Path $UNITY_PATH)) {
            Write-Host "::error::Unity executable not found at $UNITY_PATH"
            exit 1
          }

          echo "unity_path=$UNITY_PATH" >> $env:GITHUB_OUTPUT
          Write-Host "Found Unity at: $UNITY_PATH"

      - name: Create test directories
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/TestResults"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/CodeCoverage"

      - name: Run EditMode tests
        shell: powershell
        run: |
          Write-Host "Running EditMode tests..."

          $unityArgs = @(
            "-runTests",
            "-batchmode",
            "-nographics",
            "-projectPath", "${{ github.workspace }}",
            "-testPlatform", "EditMode",
            "-testResults", "${{ github.workspace }}/TestResults/EditMode-results.xml",
            "-logFile", "${{ github.workspace }}/TestResults/EditMode-log.txt",
            "-enableCodeCoverage",
            "-coverageResultsPath", "${{ github.workspace }}/CodeCoverage",
            "-coverageOptions", "generateAdditionalMetrics;generateHtmlReport;generateBadgeReport;assemblyFilters:+IrsikSoftware.LogSmith"
          )

          $process = Start-Process -FilePath "${{ steps.unity-path.outputs.unity_path }}" `
            -ArgumentList $unityArgs `
            -Wait `
            -PassThru `
            -NoNewWindow

          Write-Host "Unity exit code: $process.ExitCode"

          if (-Not (Test-Path "${{ github.workspace }}/TestResults/EditMode-results.xml")) {
            Write-Host "::error::EditMode-results.xml was not created!"
            Get-Content "${{ github.workspace }}/TestResults/EditMode-log.txt" -Tail 50 -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Run PlayMode tests
        shell: powershell
        run: |
          Write-Host "Running PlayMode tests..."

          $unityArgs = @(
            "-runTests",
            "-batchmode",
            "-nographics",
            "-projectPath", "${{ github.workspace }}",
            "-testPlatform", "PlayMode",
            "-testResults", "${{ github.workspace }}/TestResults/PlayMode-results.xml",
            "-logFile", "${{ github.workspace }}/TestResults/PlayMode-log.txt"
          )

          $process = Start-Process -FilePath "${{ steps.unity-path.outputs.unity_path }}" `
            -ArgumentList $unityArgs `
            -Wait `
            -PassThru `
            -NoNewWindow

          Write-Host "Unity exit code: $process.ExitCode"

          if (-Not (Test-Path "${{ github.workspace }}/TestResults/PlayMode-results.xml")) {
            Write-Host "::error::PlayMode-results.xml was not created!"
            Get-Content "${{ github.workspace }}/TestResults/PlayMode-log.txt" -Tail 50 -ErrorAction SilentlyContinue
            exit 1
          }

      - name: Parse test results and notify Discord
        if: always()
        shell: powershell
        run: |
          $editPassed = 0
          $editFailed = 0
          $editTotal = 0
          $playPassed = 0
          $playFailed = 0
          $playTotal = 0

          if (Test-Path "${{ github.workspace }}/TestResults/EditMode-results.xml") {
            [xml]$editXml = Get-Content "${{ github.workspace }}/TestResults/EditMode-results.xml"
            $editTotal = [int]$editXml.'test-run'.total
            $editPassed = [int]$editXml.'test-run'.passed
            $editFailed = [int]$editXml.'test-run'.failed
          }

          if (Test-Path "${{ github.workspace }}/TestResults/PlayMode-results.xml") {
            [xml]$playXml = Get-Content "${{ github.workspace }}/TestResults/PlayMode-results.xml"
            $playTotal = [int]$playXml.'test-run'.total
            $playPassed = [int]$playXml.'test-run'.passed
            $playFailed = [int]$playXml.'test-run'.failed
          }

          $totalTests = $editTotal + $playTotal
          $totalPassed = $editPassed + $playPassed
          $totalFailed = $editFailed + $playFailed

          Write-Host "EditMode: $editPassed/$editTotal passed"
          Write-Host "PlayMode: $playPassed/$playTotal passed"
          Write-Host "Total: $totalPassed/$totalTests passed, $totalFailed failed"

          # Discord notification
          if (-not "${{ secrets.TESTRESULTS_WEBHOOK }}") {
            Write-Host "TESTRESULTS_WEBHOOK not configured, skipping Discord notification"
            exit 0
          }

          $color = if ($totalFailed -eq 0) { 3066993 } else { 15158332 }
          $emoji = if ($totalFailed -eq 0) { ":white_check_mark:" } else { ":x:" }
          $status = if ($totalFailed -eq 0) { "PASSED" } else { "FAILED" }

          $runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          $payload = @{
            embeds = @(
              @{
                title = "$emoji LogSmith CI - $status"
                description = "**Unity ${{ env.UNITY_VERSION }}**`n`nEditMode: $editPassed/$editTotal | PlayMode: $playPassed/$playTotal`n`n[View Run]($runUrl)"
                color = $color
                timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
              }
            )
          } | ConvertTo-Json -Depth 10

          try {
            Invoke-RestMethod -Uri "${{ secrets.TESTRESULTS_WEBHOOK }}" -Method Post -Body $payload -ContentType "application/json"
            Write-Host "Discord notification sent"
          } catch {
            Write-Host "::warning::Discord notification failed: $_"
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Test-Results-${{ env.UNITY_VERSION }}
          path: ${{ github.workspace }}/TestResults/*
          retention-days: 30

      - name: Upload coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Coverage-Results-${{ env.UNITY_VERSION }}
          path: ${{ github.workspace }}/CodeCoverage
          retention-days: 30

      - name: Fail if tests failed
        shell: powershell
        run: |
          if (Test-Path "${{ github.workspace }}/TestResults/EditMode-results.xml") {
            [xml]$editXml = Get-Content "${{ github.workspace }}/TestResults/EditMode-results.xml"
            if ([int]$editXml.'test-run'.failed -gt 0) {
              Write-Host "::error::EditMode tests failed"
              exit 1
            }
          }

          if (Test-Path "${{ github.workspace }}/TestResults/PlayMode-results.xml") {
            [xml]$playXml = Get-Content "${{ github.workspace }}/TestResults/PlayMode-results.xml"
            if ([int]$playXml.'test-run'.failed -gt 0) {
              Write-Host "::error::PlayMode tests failed"
              exit 1
            }
          }

          Write-Host "All tests passed!"
