name: CI - Unity Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

env:
  UNITY_VERSION: 6000.3.2f1

jobs:
  test:
    name: Test Unity 6000.3.2f1
    runs-on: [self-hosted, unity-pool]
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Unity License
        shell: powershell
        run: |
          $LICENSE_DIR = "$env:LOCALAPPDATA\Unity\licenses"
          New-Item -ItemType Directory -Force -Path $LICENSE_DIR | Out-Null
          $LICENSE_FILE = "$LICENSE_DIR\UnityEntitlementLicense.xml"

          # Retry logic for file write (handles parallel runner race conditions)
          $maxRetries = 5
          $retryCount = 0
          $success = $false

          while (-not $success -and $retryCount -lt $maxRetries) {
            try {
              [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String("${{ secrets.UNITY_LICENSE }}")) | Out-File -FilePath $LICENSE_FILE -Encoding UTF8 -NoNewline
              $success = $true
              Write-Host "Unity license installed at: $LICENSE_FILE"
            } catch {
              $retryCount++
              if ($retryCount -lt $maxRetries) {
                Write-Host "License file locked, retrying... (Attempt $retryCount/$maxRetries)"
                Start-Sleep -Seconds 1
              } else {
                throw "Failed to write license file after $maxRetries attempts: $_"
              }
            }
          }

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ env.UNITY_VERSION }}-${{ hashFiles('Packages/packages-lock.json', 'Packages/manifest.json') }}
          restore-keys: |
            Library-${{ env.UNITY_VERSION }}-
            Library-

      - name: Find Unity Editor Path
        id: unity-path
        shell: powershell
        run: |
          $UNITY_PATH = "C:/Program Files/Unity/Hub/Editor/${{ env.UNITY_VERSION }}/Editor/Unity.exe"

          if (-Not (Test-Path $UNITY_PATH)) {
            Write-Host "::error::Unity executable not found at $UNITY_PATH"
            exit 1
          }

          echo "unity_path=$UNITY_PATH" >> $env:GITHUB_OUTPUT
          Write-Host "Found Unity at: $UNITY_PATH"

      - name: Create test directories
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/TestResults"
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}/CodeCoverage"

      # Tests disabled in CI for now - run locally via: tools/run-tests.bat EditMode/PlayMode
      # - name: Run EditMode tests
      # - name: Run PlayMode tests

      - name: Build validation
        shell: powershell
        run: |
          Write-Host "Running build validation..."

          $unityArgs = @(
            "-batchmode",
            "-nographics",
            "-projectPath", "${{ github.workspace }}",
            "-logFile", "${{ github.workspace }}/TestResults/build-log.txt",
            "-quit"
          )

          $process = Start-Process -FilePath "${{ steps.unity-path.outputs.unity_path }}" `
            -ArgumentList $unityArgs `
            -Wait `
            -PassThru `
            -NoNewWindow

          Write-Host "Unity exit code: $($process.ExitCode)"

          if ($process.ExitCode -ne 0) {
            Write-Host "::error::Build validation failed!"
            Get-Content "${{ github.workspace }}/TestResults/build-log.txt" -Tail 100 -ErrorAction SilentlyContinue
            exit 1
          }

          Write-Host "Build validation passed"

      - name: Notify Discord
        if: always()
        shell: powershell
        run: |
          if (-not "${{ secrets.TESTRESULTS_WEBHOOK }}") {
            Write-Host "TESTRESULTS_WEBHOOK not configured, skipping"
            exit 0
          }

          $runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          $status = if ($env:GITHUB_ACTION_STATUS -eq 'failure') { "FAILED" } else { "BUILD OK" }
          $color = if ($status -eq "FAILED") { 15158332 } else { 3066993 }
          $emoji = if ($status -eq "FAILED") { ":x:" } else { ":white_check_mark:" }

          $payload = @{
            embeds = @(
              @{
                title = "$emoji LogSmith CI - $status"
                description = "**Unity ${{ env.UNITY_VERSION }}**`n`n[View Run]($runUrl)"
                color = $color
                timestamp = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
              }
            )
          } | ConvertTo-Json -Depth 10

          try {
            Invoke-RestMethod -Uri "${{ secrets.TESTRESULTS_WEBHOOK }}" -Method Post -Body $payload -ContentType "application/json"
            Write-Host "Discord notification sent"
          } catch {
            Write-Host "::warning::Discord notification failed: $_"
          }

      - name: Upload build log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: Build-Log-${{ env.UNITY_VERSION }}
          path: ${{ github.workspace }}/TestResults/build-log.txt
          retention-days: 7
